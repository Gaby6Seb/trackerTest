<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Splashin' Live Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="/style.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.js"></script>
  <!-- NEW: OneSignal SDK -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
</head>
<body>
  <div class="header">
    <div class="header-content">
        <h1>Splashin' Live Dashboard</h1>
        <p class="subtitle">Connecting...</p>
    </div>
    <div class="user-info">
        <button id="notification-btn" style="display: none;">ðŸ””</button>
        <span id="display-name"></span>
        <button id="logout-btn">Logout</button>
    </div>
  </div>
  <div id="map"></div>
  <div id="controls-container">
    <div id="search-container">
        <input type="text" id="player-search" placeholder="Search names or teams (e.g., John, Blue Team)...">
        <button id="clear-search-btn">&times;</button>
    </div>
    <div id="filter-toggles">
      <label for="show-all-toggle">
        <input type="checkbox" id="show-all-toggle">
        Show All Players
      </label>
    </div>
    <div id="safezone-container" class="minimized">
        <h2 id="safezone-header">
            Players in Safe Zone
            <span id="safezone-toggle-icon">+</span>
        </h2>
        <ul id="safezone-list"></ul>
    </div>
    <div id="stealth-container" class="minimized">
        <h2 id="stealth-header">
            Stealthed Players
            <span id="stealth-toggle-icon">+</span>
        </h2>
        <ul id="stealth-list"></ul>
    </div>
    <div id="not-located-container" class="minimized">
        <h2 id="not-located-header">
            Players Not on Map
            <span id="toggle-icon">+</span>
        </h2>
        <ul id="not-located-list"></ul>
    </div>
  </div>

  <!-- Notification Modal -->
  <div id="notification-modal-overlay" class="modal-overlay" style="display: none;">
    <div id="notification-modal" class="modal-content">
        <button id="modal-close-btn" class="modal-close-btn">&times;</button>
        
        <div id="player-selection-step">
            <h2>Who are you?</h2>
            <p>Select your name from the list to enable notifications.</p>
            <ul id="teammate-list">
            </ul>
        </div>
        
        <div id="notification-settings-step" style="display: none;">
            <h2>Notification Settings for <span id="my-player-name"></span></h2>
            <p><a href="#" id="change-player-link">Not you? Change player.</a></p>
            
            <div class="setting-row master-toggle">
                <label for="enable-notifications">Enable All Notifications</label>
                <input type="checkbox" id="enable-notifications" class="toggle-switch">
            </div>

            <fieldset id="notification-fieldset">
                <div class="setting-row">
                    <label for="proximity-radius">Proximity Alert Radius (miles)</label>
                    <div class="range-container">
                        <input type="range" id="proximity-radius" min="0" max="10" step="0.5" value="0">
                        <span id="proximity-value">Off</span>
                    </div>
                </div>

                <div class="setting-row">
                    <label for="ghost-radius">"Ghost" Alert Radius (miles)</label>
                    <div class="range-container">
                        <input type="range" id="ghost-radius" min="0" max="10" step="0.5" value="0">
                        <span id="ghost-value">Off</span>
                    </div>
                    <label class="sub-label">
                      <input type="checkbox" id="ghost-worldwide"> No Range Limit (Worldwide)
                    </label>
                </div>
            </fieldset>
            
            <button id="save-settings-btn">Save Settings</button>
        </div>
    </div>
  </div>


<script>
    // --- NEW: OneSignal Initialization ---
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(function(OneSignal) {
        OneSignal.init({
            appId: "95e17686-f5df-4181-a59a-f89457df2973", // Public App ID
        }).then(() => {
            console.log("OneSignal SDK Initialized.");
        });
    });

    // --- Login Authentication Guard ---
    const username = localStorage.getItem('username');
    const isMaster = localStorage.getItem('isMaster') === 'true';
    const displayName = localStorage.getItem('displayName');
    const canSeeAllPlayers = localStorage.getItem('canSeeAllPlayers') === 'true';
    const canSeeLastKnownLocation = localStorage.getItem('canSeeLastKnownLocation') === 'true';
    const canUseNotifications = localStorage.getItem('canUseNotifications') === 'true';

    if (!username) {
        window.location.href = '/'; // Redirect to login page if not authenticated
    }

document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('display-name').textContent = displayName || username;
        
        if (isMaster || canSeeAllPlayers) {
            document.getElementById('filter-toggles').style.display = 'flex';
        } else {
            document.getElementById('filter-toggles').style.display = 'none';
        }

        if (canUseNotifications) {
            document.getElementById('notification-btn').style.display = 'block';
        }

        document.getElementById('logout-btn').addEventListener('click', async () => {
            const token = localStorage.getItem('authToken');
            
            if (token) {
                try {
                    await fetch('/logout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token })
                    });
                } catch (err) {
                    console.error("Failed to notify server of logout:", err);
                }
            }
            
            localStorage.clear();
            socket.disconnect();
            window.location.href = '/';
        });
    });

    const map = L.map('map').setView([33.04, -97.02], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    const markers = L.markerClusterGroup({
        maxClusterRadius: 60, disableClusteringAtZoom: 14, 
        chunkedLoading: true, spiderfyOnMaxZoom: true 
    });
    map.addLayer(markers); 

    const socket = io();
    let currentMarkers = {}; 
    let allPlayersWithLocation = [];
    let allPanelData = {};
    let showAllPlayers = false;
    let initialMapLoad = true;
    let timerUpdateInterval = null;

const createAvatarIcon = (color, avatarUrl, role, isSafeZone, isLastKnown, isStealthed) => {
  const baseClass = avatarUrl ? 'marker-pin-avatar' : 'marker-pin';
  const safeZoneClass = isSafeZone ? 'safezone-marker' : '';
  const stealthedClass = isStealthed ? 'stealthed-marker' : '';
  const lastKnownClass = isLastKnown ? 'last-known-marker' : '';
  const avatarImage = avatarUrl ? `<img src="${avatarUrl}" class="marker-avatar-image" alt="player avatar"/>` : '';
  let pinStyles = `background-color: ${color || '#3388ff'};`;
  if (!avatarUrl) { pinStyles += `border-color: ${color || '#3388ff'};`; }
  const pulseHtml = !isLastKnown ? `<div class="marker-pulse-effect ${role}-pulse"></div>` : '';
  const markerHtml = `<div class="marker-container ${role}-marker ${safeZoneClass} ${stealthedClass} ${lastKnownClass}"><div class="${baseClass}" style="${pinStyles}">${avatarImage}</div>${pulseHtml}</div>`;
  const iconSize = avatarUrl ? [40, 52] : [30, 42];
  const iconAnchor = avatarUrl ? [20, 52] : [15, 42]; 
  return L.divIcon({ className: 'custom-div-icon', html: markerHtml, iconSize: iconSize, iconAnchor: iconAnchor });
};
    
    function startTimerUpdates() {
        if (timerUpdateInterval) clearInterval(timerUpdateInterval);

        timerUpdateInterval = setInterval(() => {
            const timerElements = document.querySelectorAll('.stealth-timer');
            if (timerElements.length === 0) {
                clearInterval(timerUpdateInterval);
                timerUpdateInterval = null;
                return;
            }
            timerElements.forEach(el => {
                const expiresAt = el.dataset.expiresAt;
                if (!expiresAt) {
                    el.textContent = '';
                    return;
                }
                const remainingMs = new Date(expiresAt) - new Date();
                if (remainingMs <= 0) {
                    el.textContent = ' (Expired)';
                } else {
                    const totalSeconds = Math.floor(remainingMs / 1000);
                    const minutes = Math.floor(totalSeconds / 60);
                    const seconds = totalSeconds % 60;
                    el.textContent = ` (${minutes}:${seconds.toString().padStart(2, '0')} left)`;
                }
            });
        }, 1000);
    }

    socket.on('connect', () => {
        document.querySelector('.subtitle').textContent = 'Authenticating...';
        socket.emit('authenticate', { username });
    });

    socket.on('auth_error', (message) => {
        alert(`Authentication Error: ${message}`);
        localStorage.clear();
        window.location.href = '/';
    });
    
    socket.on('auth_success', (data) => {
        if (data.isMasterNotifier || (data.teammates && data.teammates.length > 0)) {
            setupNotificationModal(data.teammates, data.isMasterNotifier);
        }
    });

    socket.on('locationUpdate', (data) => {
      document.querySelector('.subtitle').textContent = 'Live';
      allPlayersWithLocation = [
          ...data.located.map(p => ({ ...p, statusType: 'located' })),
          ...data.safeZone.filter(p => p.lat && p.lng).map(p => ({ ...p, statusType: 'safeZone' })),
          ...data.stealthed.filter(p => p.lat && p.lng).map(p => ({ ...p, statusType: 'stealthed' })),
      ];
      allPanelData = data;

      const populateList = (containerId, listId, players, reasonKey) => {
          const container = document.getElementById(containerId);
          const list = document.getElementById(listId);
          list.innerHTML = '';
          if (players && players.length > 0) {
              players.sort((a, b) => a.firstName.localeCompare(b.firstName)).forEach(player => {
                  const listItem = document.createElement('li');
                  listItem.dataset.uid = player.u;
                  let details = reasonKey && player[reasonKey] ? ` - ${player[reasonKey]}` : '';

                  if (player.lat && player.lng) {
                      listItem.classList.add('clickable-list-item');
                      listItem.onclick = () => panToLastLocation(player.lat, player.lng);
                  }
                  
                  let timerHtml = '';
                  if (containerId === 'stealth-container' && player.stealthExpiresAt) {
                      timerHtml = `<span class="stealth-timer" data-expires-at="${player.stealthExpiresAt}"></span>`;
                  }

                  listItem.innerHTML = `<span style="color:${player.teamColor || '#999999'}; font-weight: bold;">${player.firstName} ${player.lastName || ''}</span> (${player.teamName || 'N/A'})${details}${timerHtml}`;
                  list.appendChild(listItem);
              });
              container.style.display = 'flex';
          } else {
              container.style.display = 'none';
          }
      };

      populateList('safezone-container', 'safezone-list', data.safeZone);
      populateList('stealth-container', 'stealth-list', data.stealthed);
      populateList('not-located-container', 'not-located-list', data.notLocated, 'reason');
      
      startTimerUpdates();

      filterMarkers(document.getElementById('player-search').value, initialMapLoad);
      if (initialMapLoad) initialMapLoad = false;
    });
    
    // --- UPDATED: In-App Notification (still useful when tab is open) ---
    function showInAppNotification(title, options) {
        if (!("Notification" in window)) {
           console.warn("Browser does not support desktop notifications.");
        } else if (Notification.permission === "granted") {
            new Notification(title, options);
        }
        // We no longer ask for permission here, as OneSignal handles it.
    }
    
socket.on('proximity_alert', (data) => {
    console.log('Proximity Alert:', data);
    showInAppNotification('Proximity Alert!', {
        body: `${data.player.name} (${data.player.teamName}) has entered your ${data.distance} mile radius.`
    });
});

socket.on('ghost_alert', (data) => {
    console.log('Ghost Alert:', data);
    showInAppNotification('Ghost Alert!', {
        body: `${data.player.name} (${data.player.teamName}) just went off the grid.`
    });
});



    function panToLastLocation(lat, lng) {
        map.setView([lat, lng], 17);
    }

    function expandPanel(containerId) {
        const container = document.getElementById(containerId);
        if (container && container.classList.contains('minimized')) {
            container.classList.remove('minimized');
            const icon = container.querySelector('h2 span');
            if (icon) icon.textContent = '-';
        }
    }

    function findAndExpandList(searchTerm) {
        const lowerCaseSearchTerm = searchTerm.toLowerCase();
        document.querySelectorAll('li.highlighted').forEach(el => el.classList.remove('highlighted'));
        const listsToSearch = [
            { data: allPanelData.safeZone, containerId: 'safezone-container' },
            { data: allPanelData.stealthed, containerId: 'stealth-container' },
            { data: allPanelData.notLocated, containerId: 'not-located-container' }
        ];
        for (const listInfo of listsToSearch) {
            if (listInfo.data) {
                const foundPlayer = listInfo.data.find(p => 
                    (`${p.firstName || ''} ${p.lastName || ''}`.toLowerCase().includes(lowerCaseSearchTerm)) ||
                    ((p.teamName || '').toLowerCase().includes(lowerCaseSearchTerm))
                );
                if (foundPlayer) {
                    expandPanel(listInfo.containerId);
                    const listItem = document.querySelector(`li[data-uid="${foundPlayer.u}"]`);
                    if(listItem) {
                        listItem.classList.add('highlighted');
                        listItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    return;
                }
            }
        }
    }

    const searchInput = document.getElementById('player-search');
    const clearSearchBtn = document.getElementById('clear-search-btn');

    searchInput.addEventListener('input', (e) => {
        const hasText = e.target.value.length > 0;
        clearSearchBtn.style.display = hasText ? 'block' : 'none';
        filterMarkers(e.target.value, true);
    });

    clearSearchBtn.addEventListener('click', () => {
        searchInput.value = '';
        clearSearchBtn.style.display = 'none';
        filterMarkers('', true);
        searchInput.focus();
    });

    document.getElementById('show-all-toggle').addEventListener('change', (e) => {
        showAllPlayers = e.target.checked;
        filterMarkers(searchInput.value, true);
    });

    function getDirections(buttonElement) {
        const url = `https://maps.google.com/?daddr=${buttonElement.dataset.lat},${buttonElement.dataset.lng}`;
        window.open(url, '_blank');
    }

    function filterMarkers(searchTerm, shouldFitBounds = false) {
        markers.clearLayers(); 
        const searchTerms = searchTerm.toLowerCase().split(',').map(t => t.trim()).filter(Boolean);
        const foundPlayerCoords = []; 
        const updatedUids = new Set(); 
        
        allPlayersWithLocation.forEach(user => { 
            const { u, lat, lng, firstName, lastName, teamName, teamColor, avatarUrl, role, speed, batteryLevel, isCharging, updatedAt, accuracy, isSafeZone, statusType } = user;
            
            const isNeutral = role !== 'teammate' && role !== 'target';
            const shouldDisplay = showAllPlayers || !isNeutral;
            
            if (!shouldDisplay) return;

            const fullName = `${firstName || ''} ${lastName || ''}`.toLowerCase();
            const fullTeamName = (teamName || '').toLowerCase();
            
            const isMatch = searchTerms.length === 0 || searchTerms.some(term => fullName.includes(term) || fullTeamName.includes(term));

            if (isMatch) {
                updatedUids.add(u);
                foundPlayerCoords.push(L.latLng(lat, lng));
                
                let popupContent;
                const isLastKnown = statusType === 'safeZone' || statusType === 'stealthed';

                if (isLastKnown) {
                     popupContent = `<div class="popup-header" style="background-color: ${teamColor || '#999'};"><span>${firstName} ${lastName}</span></div><div class="popup-body"><strong>Status:</strong> ${statusType === 'safeZone' ? 'In Safe Zone' : 'Stealthed'}<br><strong>Last Known Location</strong></div><div class="popup-footer">Last update: ${updatedAt ? new Date(updatedAt).toLocaleTimeString() : 'N/A'}</div>`;
                } else {
                    const batteryIcon = isCharging ? 'âš¡' : 'ðŸ”‹';
                    const batteryStatus = `${(batteryLevel * 100).toFixed(0)}% ${batteryIcon}`;
                    let roleLabel = '';
                    if (role === 'target') roleLabel = '<span class="role-label target">TARGET</span>';
                    else if (role === 'teammate') roleLabel = '<span class="role-label teammate">TEAMMATE</span>';
                    popupContent = `<div class="popup-header" style="background-color: ${teamColor || '#3388ff'};"><span>${firstName} ${lastName}</span>${roleLabel}</div><div class="popup-body"><strong>Team:</strong> ${teamName || 'N/A'}<br><strong>Speed:</strong> ${speed.toFixed(1)} m/s<br><strong>Accuracy:</strong> ${accuracy.toFixed(0)} m<br><strong>Battery:</strong> ${batteryStatus}<br></div><div class="popup-actions"><button class="popup-directions-btn" onclick="getDirections(this)" data-lat="${lat}" data-lng="${lng}">Get Directions</button></div><div class="popup-footer">Last update: ${updatedAt ? new Date(updatedAt).toLocaleTimeString() : 'N/A'}</div>`;
                }

                const isStealthed = statusType === 'stealthed';
				const playerIcon = createAvatarIcon(teamColor || '#3388ff', avatarUrl, role, isSafeZone, isLastKnown, isStealthed);

                if (currentMarkers[u]) {
                  currentMarkers[u].setLatLng([lat, lng]).setIcon(playerIcon).setPopupContent(popupContent);
                } else {
                  currentMarkers[u] = L.marker([lat, lng], { icon: playerIcon }).bindPopup(popupContent);
                }
                markers.addLayer(currentMarkers[u]);
            }
        });

        const currentlyTracked = markers.getLayers().length;
        if (document.querySelector('.subtitle').textContent !== 'Connecting...' && document.querySelector('.subtitle').textContent !== 'Authenticating...') {
            document.querySelector('.subtitle').textContent = `Tracking ${currentlyTracked} players on map.`;
        }

        if (markers.getLayers().length === 0 && searchTerms.length > 0) {
            findAndExpandList(searchTerms[0]);
        } else {
            document.querySelectorAll('li.highlighted').forEach(el => el.classList.remove('highlighted'));
        }
        
        if (shouldFitBounds) {
            if (searchTerms.length > 0 && foundPlayerCoords.length > 0) {
                if (foundPlayerCoords.length > 1) {
                    map.fitBounds(L.latLngBounds(foundPlayerCoords), { padding: [50, 50], maxZoom: 16 });
                } else {
                    map.setView(foundPlayerCoords[0], 16);
                }
            } else {
                const allVisibleCoords = allPlayersWithLocation
                    .filter(p => showAllPlayers || p.role === 'teammate' || p.role === 'target')
                    .map(p => L.latLng(p.lat, p.lng));
                
                if (allVisibleCoords.length > 0) {
                    map.fitBounds(L.latLngBounds(allVisibleCoords), { padding: [50, 50] });
                }
            }
        }
        
        for (const uid in currentMarkers) { if (!updatedUids.has(uid)) delete currentMarkers[uid]; }
    }
    
    // --- UPDATED: Notification Modal Logic with OneSignal ---
     function setupNotificationModal(teammates, isMaster = false) {
        const modalOverlay = document.getElementById('notification-modal-overlay');
        const openBtn = document.getElementById('notification-btn');
        const closeBtn = document.getElementById('modal-close-btn');
        const playerSelectionStep = document.getElementById('player-selection-step');
        const settingsStep = document.getElementById('notification-settings-step');
        const teammateList = document.getElementById('teammate-list');
        const changePlayerLink = document.getElementById('change-player-link');
        const saveBtn = document.getElementById('save-settings-btn');
        const settingsTitle = settingsStep.querySelector('h2');
        const proximitySettingRow = document.querySelector('#proximity-radius').closest('.setting-row');
        
        if (isMaster) {
            const showMasterSettings = () => {
                playerSelectionStep.style.display = 'none';
                settingsStep.style.display = 'block';
                settingsTitle.textContent = 'Master Notification Settings';
                changePlayerLink.style.display = 'none';
                proximitySettingRow.style.display = 'none';
                loadSettings(true);
            };
            openBtn.onclick = () => {
                modalOverlay.style.display = 'flex';
                showMasterSettings();
            };
        } 
        else {
            teammateList.innerHTML = '';
            teammates.forEach(player => {
                const li = document.createElement('li');
                li.textContent = player.name;
                li.dataset.id = player.id;
                li.onclick = () => {
                    localStorage.setItem('myPlayerId', player.id);
                    localStorage.setItem('myPlayerName', player.name);
                    showRegularUserSettings(player.name);
                };
                teammateList.appendChild(li);
            });

            const showRegularUserSettings = (playerName) => {
                playerSelectionStep.style.display = 'none';
                settingsStep.style.display = 'block';
                settingsTitle.innerHTML = `Notification Settings for <span id="my-player-name">${playerName}</span>`;
                changePlayerLink.style.display = 'inline';
                proximitySettingRow.style.display = 'block';
                loadSettings(false);
            };
            
            openBtn.onclick = () => {
                modalOverlay.style.display = 'flex';
                const myPlayerId = localStorage.getItem('myPlayerId');
                const myPlayerName = localStorage.getItem('myPlayerName');
                if (myPlayerId && myPlayerName) {
                    showRegularUserSettings(myPlayerName);
                } else {
                    playerSelectionStep.style.display = 'block';
                    settingsStep.style.display = 'none';
                }
            };

            changePlayerLink.onclick = (e) => {
                e.preventDefault();
                localStorage.removeItem('myPlayerId');
                localStorage.removeItem('myPlayerName');
                playerSelectionStep.style.display = 'block';
                settingsStep.style.display = 'none';
            };
        }

        const closeModal = () => modalOverlay.style.display = 'none';
        closeBtn.onclick = closeModal;
        modalOverlay.onclick = (e) => { if (e.target === modalOverlay) closeModal(); };
        
        const enableNotifications = document.getElementById('enable-notifications');
        const fieldset = document.getElementById('notification-fieldset');
        const proximitySlider = document.getElementById('proximity-radius');
        const proximityValue = document.getElementById('proximity-value');
        const ghostSlider = document.getElementById('ghost-radius');
        const ghostValue = document.getElementById('ghost-value');
        const ghostWorldwide = document.getElementById('ghost-worldwide');

        enableNotifications.onchange = () => {
            fieldset.disabled = !enableNotifications.checked;
        };
        proximitySlider.oninput = () => {
            proximityValue.textContent = proximitySlider.value > 0 ? `${proximitySlider.value} mi` : 'Off';
        };
        ghostSlider.oninput = () => {
            ghostValue.textContent = ghostSlider.value > 0 ? `${ghostSlider.value} mi` : 'Off';
        };
        ghostWorldwide.onchange = () => {
            ghostSlider.disabled = ghostWorldwide.checked;
            ghostValue.textContent = ghostWorldwide.checked ? 'Worldwide' : (ghostSlider.value > 0 ? `${ghostSlider.value} mi` : 'Off');
        };

        function loadSettings(forMaster = false) {
            const settings = JSON.parse(localStorage.getItem('notificationSettings')) || {};
            enableNotifications.checked = settings.enabled || false;
            
            if (forMaster) {
                ghostWorldwide.checked = true;
                ghostSlider.value = 0;
            } else {
                proximitySlider.value = settings.proximityMiles || 0;
                ghostSlider.value = settings.ghostMiles > 0 ? settings.ghostMiles : 0;
                ghostWorldwide.checked = settings.ghostMiles === -1;
            }
            
            proximitySlider.dispatchEvent(new Event('input'));
            ghostSlider.dispatchEvent(new Event('input'));
            ghostWorldwide.dispatchEvent(new Event('change'));
            enableNotifications.dispatchEvent(new Event('change'));
        }

        saveBtn.onclick = async () => {
            const myPlayerId = localStorage.getItem('myPlayerId');
            if (!isMaster && !myPlayerId) {
                alert("Please select your player profile first.");
                return;
            }
            
            const settings = {
                myPlayerId: isMaster ? null : myPlayerId,
                enabled: enableNotifications.checked,
                proximityMiles: isMaster ? 0 : parseFloat(proximitySlider.value),
                ghostMiles: isMaster || ghostWorldwide.checked ? -1 : parseFloat(ghostSlider.value)
            };
            
            localStorage.setItem('notificationSettings', JSON.stringify(settings));
            socket.emit('update_notification_settings', settings);

            // --- OneSignal Registration Logic ---
            if (settings.enabled) {
                await window.OneSignalDeferred.push(async (OneSignal) => {
                    await OneSignal.User.pushSubscription.optIn();
                    const oneSignalPlayerId = await OneSignal.User.getPushSubscriptionId();
                    if (oneSignalPlayerId) {
                        socket.emit('register_one_signal', oneSignalPlayerId);
                        console.log('Registered for push notifications with ID:', oneSignalPlayerId);
                    }
                });
            } else {
                await window.OneSignalDeferred.push(async (OneSignal) => {
                    await OneSignal.User.pushSubscription.optOut();
                    console.log('Opted out of push notifications.');
                });
            }
            
            closeModal();
            alert('Settings saved!');
        };
    }

    
    socket.on('disconnect', () => document.querySelector('.subtitle').textContent = 'Disconnected...');
    
    const setupCollapsiblePanel = (headerId, containerId, iconId) => {
        const header = document.getElementById(headerId);
        const container = document.getElementById(containerId);
        const icon = document.getElementById(iconId);
        header.addEventListener('click', () => {
            container.classList.toggle('minimized');
            icon.textContent = container.classList.contains('minimized') ? '+' : '-';
        });
    };

    setupCollapsiblePanel('safezone-header', 'safezone-container', 'safezone-toggle-icon');
    setupCollapsiblePanel('stealth-header', 'stealth-container', 'stealth-toggle-icon');
    setupCollapsiblePanel('not-located-header', 'not-located-container', 'toggle-icon');
</script>

</body>
</html>

