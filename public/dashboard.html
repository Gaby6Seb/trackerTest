<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Splashin' Live Dashboard</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="/style.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.js"></script>
  <!-- OneSignal SDK -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  
</head>
<body>
  <div class="header">
    <div class="header-content">
        <h1>Splashin' Live Dashboard</h1>
        <p class="subtitle">Connecting...</p>
    </div>
    <div class="user-info">
        <button id="notification-btn" style="display: none;">ðŸ””</button>
        <span id="display-name"></span>
        <button id="logout-btn">Logout</button>
    </div>
  </div>
  <div id="map"></div>
  <div id="controls-container">
    <div id="search-container">
        <input type="text" id="player-search" placeholder="Search names or teams (e.g., John, Blue Team)...">
        <button id="clear-search-btn">&times;</button>
    </div>
    <div id="filter-toggles">
      <label for="show-all-toggle">
        <input type="checkbox" id="show-all-toggle">
        Show All Players
      </label>
    </div>
    <div id="safezone-container" class="minimized">
        <h2 id="safezone-header">
            Players in Safe Zone
            <span id="safezone-toggle-icon">+</span>
        </h2>
        <ul id="safezone-list"></ul>
    </div>
    <div id="stealth-container" class="minimized">
        <h2 id="stealth-header">
            Stealthed Players
            <span id="stealth-toggle-icon">+</span>
        </h2>
        <ul id="stealth-list"></ul>
    </div>
    <div id="not-located-container" class="minimized">
        <h2 id="not-located-header">
            Players Not on Map
            <span id="toggle-icon">+</span>
        </h2>
        <ul id="not-located-list"></ul>
    </div>
  </div>

  <!-- Notification Modal -->
  <div id="notification-modal-overlay" class="modal-overlay" style="display: none;">
    <div id="notification-modal" class="modal-content">
        <button id="modal-close-btn" class="modal-close-btn">&times;</button>
        
        <div id="player-selection-step">
            <h2>Who are you?</h2>
            <p>Select your name from the list to enable notifications.</p>
            <ul id="teammate-list">
            </ul>
        </div>
        
        <div id="notification-settings-step" style="display: none;">
            <h2>Notification Settings for <span id="my-player-name"></span></h2>
            <p><a href="#" id="change-player-link">Not you? Change player.</a></p>
            
            <div class="setting-row master-toggle">
                <label>Manage Subscription</label>
                <div class='onesignal-customlink-container'></div>
            </div>

            <div class="setting-row master-toggle">
                <label for="enable-notifications">Enable Alert Preferences</label>
                <input type="checkbox" id="enable-notifications" class="toggle-switch">
            </div>

            <fieldset id="notification-fieldset">
                <div class="setting-row">
                    <label for="proximity-radius">Proximity Alert Radius (miles)</label>
                    <div class="range-container">
                        <input type="range" id="proximity-radius" min="0" max="10" step="0.5" value="0">
                        <span id="proximity-value">Off</span>
                    </div>
                </div>

                <div class="setting-row">
                    <label for="ghost-radius">"Ghost" Alert Radius (miles)</label>
                    <div class="range-container">
                        <input type="range" id="ghost-radius" min="0" max="10" step="0.5" value="0">
                        <span id="ghost-value">Off</span>
                    </div>
                    <label class="sub-label">
                      <input type="checkbox" id="ghost-worldwide"> No Range Limit (Worldwide)
                    </label>
                </div>
            </fieldset>
            
            <button id="save-settings-btn">Save Alert Preferences</button>
        </div>
    </div>
  </div>


<script>
// --- OneSignal Initialization ---
function initializeOneSignal(retries = 3, delay = 2000) {
    if (window.OneSignal) {
        OneSignal.init({
            appId: "95e17686-f5df-4181-a59a-f89457df2973",
            allowLocalhostAsSecureOrigin: true,
        }).then(() => {
            console.log("OneSignal SDK Initialized successfully.");
            if (OneSignal.User.pushSubscription) {
                OneSignal.User.pushSubscription.addEventListener('change', (isSubscribed) => {
                    console.log('Push subscription state changed:', isSubscribed);
                    if (isSubscribed) {
                        const oneSignalPlayerId = OneSignal.User.pushSubscription.id;
                        if (oneSignalPlayerId) {
                            socket.emit('register_one_signal', oneSignalPlayerId);
                            console.log('Registered OneSignal player ID:', oneSignalPlayerId);
                        }
                    }
                    if (document.getElementById('notification-modal-overlay').style.display === 'flex') {
                        checkSubscriptionStatus();
                    }
                });
                checkSubscriptionStatus(); // Check immediately after initialization
            } else {
                console.warn("Push subscriptions are not supported or available on this browser.");
                document.getElementById('notification-btn').style.display = 'none';
            }
        }).catch((error) => {
            console.error("OneSignal SDK initialization failed:", error);
            if (retries > 0) {
                console.log(`Retrying OneSignal initialization... (${retries} attempts left)`);
                setTimeout(() => initializeOneSignal(retries - 1, delay * 2), delay);
            } else {
                alert('Failed to initialize push notifications. Please try refreshing the page.');
                document.getElementById('notification-btn').style.display = 'none';
            }
        });
    } else {
        if (retries > 0) {
            console.log(`OneSignal SDK not loaded. Retrying... (${retries} attempts left)`);
            setTimeout(() => initializeOneSignal(retries - 1, delay * 2), delay);
        } else {
            console.error("OneSignal SDK failed to load after retries.");
            alert('Push notifications are unavailable. Please ensure the OneSignal SDK is loaded.');
            document.getElementById('notification-btn').style.display = 'none';
        }
    }
	// Inside initializeOneSignal, after OneSignal.init
OneSignal.Notifications.addEventListener('permissionChange', (permission) => {
    console.log('Notification permission changed:', permission);
    checkSubscriptionStatus();
});
}

window.OneSignalDeferred = window.OneSignalDeferred || [];
OneSignalDeferred.push(() => initializeOneSignal());

    // --- Login Authentication Guard ---
    const username = localStorage.getItem('username');
    const isMaster = localStorage.getItem('isMaster') === 'true';
    const displayName = localStorage.getItem('displayName');
    const canSeeAllPlayers = localStorage.getItem('canSeeAllPlayers') === 'true';
    const canSeeLastKnownLocation = localStorage.getItem('canSeeLastKnownLocation') === 'true';
    const canUseNotifications = localStorage.getItem('canUseNotifications') === 'true';

    if (!username) {
        window.location.href = '/';
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('display-name').textContent = displayName || username;
        
        if (isMaster || canSeeAllPlayers) {
            document.getElementById('filter-toggles').style.display = 'flex';
        } else {
            document.getElementById('filter-toggles').style.display = 'none';
        }

        if (canUseNotifications) {
            document.getElementById('notification-btn').style.display = 'block';
        }

        document.getElementById('logout-btn').addEventListener('click', async () => {
            const token = localStorage.getItem('authToken');
            
            if (token) {
                try {
                    await fetch('/logout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token })
                    });
                } catch (err) {
                    console.error("Failed to notify server of logout:", err);
                }
            }
            
            localStorage.clear();
            socket.disconnect();
            window.location.href = '/';
        });
    });

    const map = L.map('map').setView([33.04, -97.02], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    const markers = L.markerClusterGroup({
        maxClusterRadius: 60, disableClusteringAtZoom: 14, 
        chunkedLoading: true, spiderfyOnMaxZoom: true 
    });
    map.addLayer(markers); 

    const socket = io();
    let currentMarkers = {}; 
    let allPlayersWithLocation = [];
    let allPanelData = {};
    let showAllPlayers = false;
    let initialMapLoad = true;
    let timerUpdateInterval = null;

    const createAvatarIcon = (color, avatarUrl, role, isSafeZone, isLastKnown, isStealthed) => {
      const baseClass = avatarUrl ? 'marker-pin-avatar' : 'marker-pin';
      const safeZoneClass = isSafeZone ? 'safezone-marker' : '';
      const stealthedClass = isStealthed ? 'stealthed-marker' : '';
      const lastKnownClass = isLastKnown ? 'last-known-marker' : '';
      const avatarImage = avatarUrl ? `<img src="${avatarUrl}" class="marker-avatar-image" alt="player avatar"/>` : '';
      let pinStyles = `background-color: ${color || '#3388ff'};`;
      if (!avatarUrl) { pinStyles += `border-color: ${color || '#3388ff'};`; }
      const pulseHtml = !isLastKnown ? `<div class="marker-pulse-effect ${role}-pulse"></div>` : '';
      const markerHtml = `<div class="marker-container ${role}-marker ${safeZoneClass} ${stealthedClass} ${lastKnownClass}"><div class="${baseClass}" style="${pinStyles}">${avatarImage}</div>${pulseHtml}</div>`;
      const iconSize = avatarUrl ? [40, 52] : [30, 42];
      const iconAnchor = avatarUrl ? [20, 52] : [15, 42]; 
      return L.divIcon({ className: 'custom-div-icon', html: markerHtml, iconSize: iconSize, iconAnchor: iconAnchor });
    };
    
    function startTimerUpdates() {
        if (timerUpdateInterval) clearInterval(timerUpdateInterval);
        timerUpdateInterval = setInterval(() => {
            document.querySelectorAll('.stealth-timer').forEach(el => {
                const expiresAt = el.dataset.expiresAt;
                if (!expiresAt) { el.textContent = ''; return; }
                const remainingMs = new Date(expiresAt) - new Date();
                if (remainingMs <= 0) { el.textContent = ' (Expired)'; } 
                else {
                    const totalSeconds = Math.floor(remainingMs / 1000);
                    const minutes = Math.floor(totalSeconds / 60);
                    const seconds = totalSeconds % 60;
                    el.textContent = ` (${minutes}:${seconds.toString().padStart(2, '0')} left)`;
                }
            });
        }, 1000);
    }

    socket.on('connect', () => {
        document.querySelector('.subtitle').textContent = 'Authenticating...';
        socket.emit('authenticate', { username });
    });

    socket.on('auth_error', (message) => {
        alert(`Authentication Error: ${message}`);
        localStorage.clear();
        window.location.href = '/';
    });
    
    socket.on('auth_success', (data) => {
        if (data.teammates) {
            setupNotificationModal(data.teammates);
        }
    });

    socket.on('locationUpdate', (data) => {
      document.querySelector('.subtitle').textContent = 'Live';
      allPlayersWithLocation = [
          ...data.located.map(p => ({ ...p, statusType: 'located' })),
          ...data.safeZone.filter(p => p.lat && p.lng).map(p => ({ ...p, statusType: 'safeZone' })),
          ...data.stealthed.filter(p => p.lat && p.lng).map(p => ({ ...p, statusType: 'stealthed' })),
      ];
      allPanelData = data;

      const listMapping = [
        { containerId: 'safezone-container', listId: 'safezone-list', data: data.safeZone },
        { containerId: 'stealth-container', listId: 'stealth-list', data: data.stealthed },
        { containerId: 'not-located-container', listId: 'not-located-list', data: data.notLocated, reasonKey: 'reason' }
      ];

      listMapping.forEach(({ containerId, listId, data: players, reasonKey }) => {
          const container = document.getElementById(containerId);
          const list = document.getElementById(listId);
          list.innerHTML = ''; 
          container.style.display = 'flex';

          if (players && players.length > 0) {
              players.sort((a, b) => a.firstName.localeCompare(b.firstName)).forEach(player => {
                  const listItem = document.createElement('li');
                  listItem.dataset.uid = player.u;
                  let details = reasonKey && player[reasonKey] ? ` - ${player[reasonKey]}` : '';

                  if (player.lat && player.lng) {
                      listItem.classList.add('clickable-list-item');
                      listItem.onclick = () => panToLastLocation(player.lat, player.lng);
                  }
                  
                  let timerHtml = '';
                  if (containerId === 'stealth-container' && player.stealthExpiresAt) {
                      timerHtml = `<span class="stealth-timer" data-expires-at="${player.stealthExpiresAt}"></span>`;
                  }

                  listItem.innerHTML = `<span style="color:${player.teamColor || '#999999'}; font-weight: bold;">${player.firstName} ${player.lastName || ''}</span> (${player.teamName || 'N/A'})${details}${timerHtml}`;
                  list.appendChild(listItem);
              });
          } else {
              list.innerHTML = `<li class="empty-list-message">No players in this category.</li>`;
          }
      });
      
      startTimerUpdates();
      filterMarkers(document.getElementById('player-search').value, initialMapLoad);
      if (initialMapLoad) initialMapLoad = false;
    });
    
socket.on('proximity_alert', (data) => {
    console.log('Proximity Alert:', JSON.stringify(data, null, 2));
    alert(`Proximity Alert: ${data.player.name} (${data.player.teamName}) is ${data.distance} miles away!`);
});

socket.on('ghost_alert', (data) => {
    console.log('Ghost Alert:', JSON.stringify(data, null, 2));
    alert(`Ghost Alert: ${data.player.name} (${data.player.teamName}) went off the grid!`);
});
    function panToLastLocation(lat, lng) { map.setView([lat, lng], 17); }

    function expandPanel(containerId) {
        const container = document.getElementById(containerId);
        if (container && container.classList.contains('minimized')) {
            container.classList.remove('minimized');
            const icon = container.querySelector('h2 span');
            if (icon) icon.textContent = '-';
        }
    }

    function findAndExpandList(searchTerm) {
        const lowerCaseSearchTerm = searchTerm.toLowerCase();
        document.querySelectorAll('li.highlighted').forEach(el => el.classList.remove('highlighted'));
        const listsToSearch = [
            { data: allPanelData.safeZone, containerId: 'safezone-container' },
            { data: allPanelData.stealthed, containerId: 'stealth-container' },
            { data: allPanelData.notLocated, containerId: 'not-located-container' }
        ];
        for (const listInfo of listsToSearch) {
            if (listInfo.data) {
                const foundPlayer = listInfo.data.find(p => 
                    (`${p.firstName || ''} ${p.lastName || ''}`.toLowerCase().includes(lowerCaseSearchTerm)) ||
                    ((p.teamName || '').toLowerCase().includes(lowerCaseSearchTerm))
                );
                if (foundPlayer) {
                    expandPanel(listInfo.containerId);
                    const listItem = document.querySelector(`li[data-uid="${foundPlayer.u}"]`);
                    if(listItem) {
                        listItem.classList.add('highlighted');
                        listItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    return;
                }
            }
        }
    }

    const searchInput = document.getElementById('player-search');
    const clearSearchBtn = document.getElementById('clear-search-btn');

    searchInput.addEventListener('input', (e) => {
        clearSearchBtn.style.display = e.target.value.length > 0 ? 'block' : 'none';
        filterMarkers(e.target.value, true);
    });

    clearSearchBtn.addEventListener('click', () => {
        searchInput.value = '';
        clearSearchBtn.style.display = 'none';
        filterMarkers('', true);
        searchInput.focus();
    });

    document.getElementById('show-all-toggle').addEventListener('change', (e) => {
        showAllPlayers = e.target.checked;
        filterMarkers(searchInput.value, true);
    });

    function getDirections(buttonElement) {
        const url = `https://maps.google.com/?daddr=${buttonElement.dataset.lat},${buttonElement.dataset.lng}`;
        window.open(url, '_blank');
    }

    function filterMarkers(searchTerm, shouldFitBounds = false) {
        markers.clearLayers(); 
        const searchTerms = searchTerm.toLowerCase().split(',').map(t => t.trim()).filter(Boolean);
        const foundPlayerCoords = []; 
        const updatedUids = new Set(); 
        
        allPlayersWithLocation.forEach(user => { 
            const { u, lat, lng, firstName, lastName, teamName, teamColor, avatarUrl, role, speed, batteryLevel, isCharging, updatedAt, accuracy, isSafeZone, statusType } = user;
            
            const isNeutral = role !== 'teammate' && role !== 'target';
            const shouldDisplay = showAllPlayers || !isNeutral;
            
            if (!shouldDisplay) return;

            const fullName = `${firstName || ''} ${lastName || ''}`.toLowerCase();
            const fullTeamName = (teamName || '').toLowerCase();
            
            const isMatch = searchTerms.length === 0 || searchTerms.some(term => fullName.includes(term) || fullTeamName.includes(term));

            if (isMatch) {
                updatedUids.add(u);
                foundPlayerCoords.push(L.latLng(lat, lng));
                
                let popupContent;
                const isLastKnown = statusType === 'safeZone' || statusType === 'stealthed';

                if (isLastKnown) {
                     popupContent = `<div class="popup-header" style="background-color: ${teamColor || '#999'};"><span>${firstName} ${lastName}</span></div><div class="popup-body"><strong>Status:</strong> ${statusType === 'safeZone' ? 'In Safe Zone' : 'Stealthed'}<br><strong>Last Known Location</strong></div><div class="popup-footer">Last update: ${updatedAt ? new Date(updatedAt).toLocaleTimeString() : 'N/A'}</div>`;
                } else {
                    const batteryIcon = isCharging ? 'âš¡' : 'ðŸ”‹';
                    const batteryStatus = `${(batteryLevel * 100).toFixed(0)}% ${batteryIcon}`;
                    let roleLabel = '';
                    if (role === 'target') roleLabel = '<span class="role-label target">TARGET</span>';
                    else if (role === 'teammate') roleLabel = '<span class="role-label teammate">TEAMMATE</span>';
                    popupContent = `<div class="popup-header" style="background-color: ${teamColor || '#3388ff'};"><span>${firstName} ${lastName}</span>${roleLabel}</div><div class="popup-body"><strong>Team:</strong> ${teamName || 'N/A'}<br><strong>Speed:</strong> ${speed.toFixed(1)} m/s<br><strong>Accuracy:</strong> ${accuracy.toFixed(0)} m<br><strong>Battery:</strong> ${batteryStatus}<br></div><div class="popup-actions"><button class="popup-directions-btn" onclick="getDirections(this)" data-lat="${lat}" data-lng="${lng}">Get Directions</button></div><div class="popup-footer">Last update: ${updatedAt ? new Date(updatedAt).toLocaleTimeString() : 'N/A'}</div>`;
                }

                const isStealthed = statusType === 'stealthed';
				const playerIcon = createAvatarIcon(teamColor || '#3388ff', avatarUrl, role, isSafeZone, isLastKnown, isStealthed);

                if (currentMarkers[u]) {
                  currentMarkers[u].setLatLng([lat, lng]).setIcon(playerIcon).setPopupContent(popupContent);
                } else {
                  currentMarkers[u] = L.marker([lat, lng], { icon: playerIcon }).bindPopup(popupContent);
                }
                markers.addLayer(currentMarkers[u]);
            }
        });

        const currentlyTracked = markers.getLayers().length;
        if (document.querySelector('.subtitle').textContent !== 'Connecting...' && document.querySelector('.subtitle').textContent !== 'Authenticating...') {
            document.querySelector('.subtitle').textContent = `Tracking ${currentlyTracked} players on map.`;
        }

        if (markers.getLayers().length === 0 && searchTerms.length > 0) {
            findAndExpandList(searchTerms[0]);
        } else {
            document.querySelectorAll('li.highlighted').forEach(el => el.classList.remove('highlighted'));
        }
        
        if (shouldFitBounds) {
            if (searchTerms.length > 0 && foundPlayerCoords.length > 0) {
                if (foundPlayerCoords.length > 1) {
                    map.fitBounds(L.latLngBounds(foundPlayerCoords), { padding: [50, 50], maxZoom: 16 });
                } else {
                    map.setView(foundPlayerCoords[0], 16);
                    if (updatedUids.size === 1) {
                        const singleMarker = currentMarkers[updatedUids.values().next().value];
                        if (singleMarker) {
                            singleMarker.openPopup();
                        }
                    }
                }
            } else {
                const allVisibleCoords = allPlayersWithLocation
                    .filter(p => showAllPlayers || p.role === 'teammate' || p.role === 'target')
                    .map(p => L.latLng(p.lat, p.lng));
                
                if (allVisibleCoords.length > 0) {
                    map.fitBounds(L.latLngBounds(allVisibleCoords), { padding: [50, 50] });
                }
            }
        }
        
        for (const uid in currentMarkers) { if (!updatedUids.has(uid)) delete currentMarkers[uid]; }
    }
    
    const subscribeContainer = document.querySelector('.onesignal-customlink-container');
    
    function handleSubscribeClick() {
        OneSignalDeferred.push(function(OneSignal) {
            // optIn() will show the native browser prompt to new users.
            OneSignal.User.pushSubscription.optIn().then(() => {
                 console.log('User successfully opted in.');
                 // The 'change' event listener will handle the rest.
            }).catch((error) => {
                 alert('There was an issue subscribing. Please check browser permissions in the address bar.');
                 console.error('Subscription error:', error);
            });
        });
    }

    function handleUnsubscribeClick() {
        OneSignalDeferred.push(function(OneSignal) {
             OneSignal.User.pushSubscription.optOut().then(() => {
                console.log('User successfully opted out.');
             });
        });
    }

    // This function is now robust and handles all user states correctly.
function checkSubscriptionStatus() {
    OneSignalDeferred.push(async function(OneSignal) {
        subscribeContainer.innerHTML = '';
        const button = document.createElement('button');

        // Check notification permission status
        const permission = await OneSignal.Notifications.permission;
        if (permission === 'denied') {
            button.textContent = 'Enable Notifications (Blocked)';
            button.onclick = () => {
                alert('Notifications are blocked. Please enable them in your browser settings and try again.');
            };
            button.className = 'subscribe-btn disabled';
        } else if (OneSignal.User.pushSubscription) {
            const isSubscribed = await OneSignal.User.pushSubscription.getOptedIn();
            if (isSubscribed) {
                button.textContent = 'Unsubscribe from Push Notifications';
                button.onclick = handleUnsubscribeClick;
                button.className = 'unsubscribe-btn';
            } else {
                button.textContent = 'Subscribe to Push Notifications';
                button.onclick = handleSubscribeClick;
                button.className = 'subscribe-btn';
            }
        } else {
            button.textContent = 'Subscribe to Push Notifications';
            button.onclick = handleSubscribeClick;
            button.className = 'subscribe-btn';
        }
        subscribeContainer.appendChild(button);
    });
}

    function setupNotificationModal(teammates) {
        const modalOverlay = document.getElementById('notification-modal-overlay');
        const openBtn = document.getElementById('notification-btn');
        const closeBtn = document.getElementById('modal-close-btn');
        const playerSelectionStep = document.getElementById('player-selection-step');
        const settingsStep = document.getElementById('notification-settings-step');
        const teammateList = document.getElementById('teammate-list');
        const changePlayerLink = document.getElementById('change-player-link');
        const saveBtn = document.getElementById('save-settings-btn');
        const settingsTitle = settingsStep.querySelector('h2');
        
        teammateList.innerHTML = '';
        if (teammates && teammates.length > 0) {
            teammates.forEach(player => {
                const li = document.createElement('li');
                li.textContent = player.name;
                li.dataset.id = player.id;
                li.onclick = () => {
                    localStorage.setItem('myPlayerId', player.id);
                    localStorage.setItem('myPlayerName', player.name);
                    showUserSettings(player.name);
                };
                teammateList.appendChild(li);
            });
        } else {
            playerSelectionStep.querySelector('p').textContent = 'No teammates are available to select for notifications at this time.';
        }

        const showUserSettings = (playerName) => {
            playerSelectionStep.style.display = 'none';
            settingsStep.style.display = 'block';
            settingsTitle.innerHTML = `Notification Settings for <span id="my-player-name">${playerName}</span>`;
            loadSettings();
            checkSubscriptionStatus();
        };
        
        openBtn.onclick = () => {
            modalOverlay.style.display = 'flex';
            const myPlayerId = localStorage.getItem('myPlayerId');
            const myPlayerName = localStorage.getItem('myPlayerName');
            if (myPlayerId && myPlayerName) {
                showUserSettings(myPlayerName);
            } else {
                playerSelectionStep.style.display = 'block';
                settingsStep.style.display = 'none';
                checkSubscriptionStatus(); 
            }
        };

        changePlayerLink.onclick = (e) => {
            e.preventDefault();
            localStorage.removeItem('myPlayerId');
            localStorage.removeItem('myPlayerName');
            playerSelectionStep.style.display = 'block';
            settingsStep.style.display = 'none';
        };

        const closeModal = () => modalOverlay.style.display = 'none';
        closeBtn.onclick = closeModal;
        modalOverlay.onclick = (e) => { if (e.target === modalOverlay) closeModal(); };
        
        const enableNotifications = document.getElementById('enable-notifications');
        const fieldset = document.getElementById('notification-fieldset');
        const proximitySlider = document.getElementById('proximity-radius');
        const proximityValue = document.getElementById('proximity-value');
        const ghostSlider = document.getElementById('ghost-radius');
        const ghostValue = document.getElementById('ghost-value');
        const ghostWorldwide = document.getElementById('ghost-worldwide');

        enableNotifications.onchange = () => { fieldset.disabled = !enableNotifications.checked; };
        proximitySlider.oninput = () => { proximityValue.textContent = proximitySlider.value > 0 ? `${proximitySlider.value} mi` : 'Off'; };
        ghostSlider.oninput = () => { ghostValue.textContent = ghostSlider.value > 0 ? `${ghostSlider.value} mi` : 'Off'; };
        ghostWorldwide.onchange = () => {
            ghostSlider.disabled = ghostWorldwide.checked;
            ghostValue.textContent = ghostWorldwide.checked ? 'Worldwide' : (ghostSlider.value > 0 ? `${ghostSlider.value} mi` : 'Off');
        };

        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('notificationSettings')) || {};
            enableNotifications.checked = settings.hasOwnProperty('enabled') ? settings.enabled : true;
            proximitySlider.value = settings.proximityMiles || 0;
            ghostSlider.value = settings.ghostMiles > 0 ? settings.ghostMiles : 0;
            ghostWorldwide.checked = settings.ghostMiles === -1;
            proximitySlider.dispatchEvent(new Event('input'));
            ghostSlider.dispatchEvent(new Event('input'));
            ghostWorldwide.dispatchEvent(new Event('change'));
            enableNotifications.dispatchEvent(new Event('change'));
        }
        
        saveBtn.onclick = async () => {
            const myPlayerId = localStorage.getItem('myPlayerId');
            const proximityMiles = parseFloat(proximitySlider.value);

            if (proximityMiles > 0 && !myPlayerId) {
                alert("Please select your player profile to enable proximity alerts.");
                return;
            }
            
            const settings = {
                myPlayerId: myPlayerId, 
                enabled: enableNotifications.checked,
                proximityMiles: proximityMiles, 
                ghostMiles: ghostWorldwide.checked ? -1 : parseFloat(ghostSlider.value)
            };
            
            localStorage.setItem('notificationSettings', JSON.stringify(settings));
            socket.emit('update_notification_settings', settings);

            closeModal();
            alert('Alert preferences saved!');
        };
    } 

    socket.on('disconnect', () => document.querySelector('.subtitle').textContent = 'Disconnected...');
    
    const setupCollapsiblePanel = (headerId, containerId, iconId) => {
        const header = document.getElementById(headerId);
        const container = document.getElementById(containerId);
        const icon = document.getElementById(iconId);
        header.addEventListener('click', () => {
            container.classList.toggle('minimized');
            icon.textContent = container.classList.contains('minimized') ? '+' : '-';
        });
    };

    setupCollapsiblePanel('safezone-header', 'safezone-container', 'safezone-toggle-icon');
    setupCollapsiblePanel('stealth-header', 'stealth-container', 'stealth-toggle-icon');
    setupCollapsiblePanel('not-located-header', 'not-located-container', 'toggle-icon');
</script>

</body>
</html>







