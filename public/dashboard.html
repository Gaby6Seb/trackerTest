<script>
    // --- OneSignal Initialization ---
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(function(OneSignal) {
        OneSignal.init({
            appId: "95e17686-f5df-4181-a59a-f89457df2973", // Public App ID
            allowLocalhostAsSecureOrigin: true,
            // The custom link container will be handled by our own modal logic now
        }).then(() => {
            console.log("OneSignal SDK Initialized.");
            // This event listener is a great fallback to catch any subscription changes
            OneSignal.User.pushSubscription.addEventListener('change', (isSubscribed) => {
                console.log('Push subscription state changed:', isSubscribed);
                if (isSubscribed) {
                    const oneSignalPlayerId = OneSignal.User.pushSubscription.id;
                    if (oneSignalPlayerId) {
                        socket.emit('register_one_signal', oneSignalPlayerId);
                    }
                }
                 // When the modal is open, update its UI
                if (document.getElementById('notification-modal-overlay').style.display === 'flex') {
                    checkSubscriptionStatus();
                }
            });
        });
    });

    // --- Login Authentication Guard ---
    const username = localStorage.getItem('username');
    const isMaster = localStorage.getItem('isMaster') === 'true';
    const displayName = localStorage.getItem('displayName');
    const canSeeAllPlayers = localStorage.getItem('canSeeAllPlayers') === 'true';
    const canSeeLastKnownLocation = localStorage.getItem('canSeeLastKnownLocation') === 'true';
    const canUseNotifications = localStorage.getItem('canUseNotifications') === 'true';

    if (!username) {
        window.location.href = '/';
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('display-name').textContent = displayName || username;
        
        if (isMaster || canSeeAllPlayers) {
            document.getElementById('filter-toggles').style.display = 'flex';
        } else {
            document.getElementById('filter-toggles').style.display = 'none';
        }

        if (canUseNotifications) {
            document.getElementById('notification-btn').style.display = 'block';
        }

        document.getElementById('logout-btn').addEventListener('click', async () => {
            const token = localStorage.getItem('authToken');
            
            if (token) {
                try {
                    await fetch('/logout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token })
                    });
                } catch (err) {
                    console.error("Failed to notify server of logout:", err);
                }
            }
            
            localStorage.clear();
            socket.disconnect();
            window.location.href = '/';
        });
    });

    const map = L.map('map').setView([33.04, -97.02], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    const markers = L.markerClusterGroup({
        maxClusterRadius: 60, disableClusteringAtZoom: 14, 
        chunkedLoading: true, spiderfyOnMaxZoom: true 
    });
    map.addLayer(markers); 

    const socket = io();
    let currentMarkers = {}; 
    let allPlayersWithLocation = [];
    let allPanelData = {};
    let showAllPlayers = false;
    let initialMapLoad = true;
    let timerUpdateInterval = null;

    const createAvatarIcon = (color, avatarUrl, role, isSafeZone, isLastKnown, isStealthed) => {
      const baseClass = avatarUrl ? 'marker-pin-avatar' : 'marker-pin';
      const safeZoneClass = isSafeZone ? 'safezone-marker' : '';
      const stealthedClass = isStealthed ? 'stealthed-marker' : '';
      const lastKnownClass = isLastKnown ? 'last-known-marker' : '';
      const avatarImage = avatarUrl ? `<img src="${avatarUrl}" class="marker-avatar-image" alt="player avatar"/>` : '';
      let pinStyles = `background-color: ${color || '#3388ff'};`;
      if (!avatarUrl) { pinStyles += `border-color: ${color || '#3388ff'};`; }
      const pulseHtml = !isLastKnown ? `<div class="marker-pulse-effect ${role}-pulse"></div>` : '';
      const markerHtml = `<div class="marker-container ${role}-marker ${safeZoneClass} ${stealthedClass} ${lastKnownClass}"><div class="${baseClass}" style="${pinStyles}">${avatarImage}</div>${pulseHtml}</div>`;
      const iconSize = avatarUrl ? [40, 52] : [30, 42];
      const iconAnchor = avatarUrl ? [20, 52] : [15, 42]; 
      return L.divIcon({ className: 'custom-div-icon', html: markerHtml, iconSize: iconSize, iconAnchor: iconAnchor });
    };
    
    function startTimerUpdates() {
        if (timerUpdateInterval) clearInterval(timerUpdateInterval);
        timerUpdateInterval = setInterval(() => {
            document.querySelectorAll('.stealth-timer').forEach(el => {
                const expiresAt = el.dataset.expiresAt;
                if (!expiresAt) { el.textContent = ''; return; }
                const remainingMs = new Date(expiresAt) - new Date();
                if (remainingMs <= 0) { el.textContent = ' (Expired)'; } 
                else {
                    const totalSeconds = Math.floor(remainingMs / 1000);
                    const minutes = Math.floor(totalSeconds / 60);
                    const seconds = totalSeconds % 60;
                    el.textContent = ` (${minutes}:${seconds.toString().padStart(2, '0')} left)`;
                }
            });
        }, 1000);
    }

    socket.on('connect', () => {
        document.querySelector('.subtitle').textContent = 'Authenticating...';
        socket.emit('authenticate', { username });
    });

    socket.on('auth_error', (message) => {
        alert(`Authentication Error: ${message}`);
        localStorage.clear();
        window.location.href = '/';
    });
    
    socket.on('auth_success', (data) => {
        if (data.teammates) {
            setupNotificationModal(data.teammates);
        }
    });

    socket.on('locationUpdate', (data) => {
      document.querySelector('.subtitle').textContent = 'Live';
      allPlayersWithLocation = [
          ...data.located.map(p => ({ ...p, statusType: 'located' })),
          ...data.safeZone.filter(p => p.lat && p.lng).map(p => ({ ...p, statusType: 'safeZone' })),
          ...data.stealthed.filter(p => p.lat && p.lng).map(p => ({ ...p, statusType: 'stealthed' })),
      ];
      allPanelData = data;
      const populateList = (containerId, listId, players, reasonKey) => { /* ... (no changes in this function) */ };
      populateList('safezone-container', 'safezone-list', data.safeZone);
      populateList('stealth-container', 'stealth-list', data.stealthed);
      populateList('not-located-container', 'not-located-list', data.notLocated, 'reason');
      startTimerUpdates();
      filterMarkers(document.getElementById('player-search').value, initialMapLoad);
      if (initialMapLoad) initialMapLoad = false;
    });
    
    socket.on('proximity_alert', (data) => console.log('Proximity Alert:', data));
    socket.on('ghost_alert', (data) => console.log('Ghost Alert:', data));
    function panToLastLocation(lat, lng) { map.setView([lat, lng], 17); }
    function expandPanel(containerId) { /* ... (no changes) */ }
    function findAndExpandList(searchTerm) { /* ... (no changes) */ }

    const searchInput = document.getElementById('player-search');
    const clearSearchBtn = document.getElementById('clear-search-btn');

    searchInput.addEventListener('input', (e) => {
        clearSearchBtn.style.display = e.target.value.length > 0 ? 'block' : 'none';
        filterMarkers(e.target.value, true);
    });

    clearSearchBtn.addEventListener('click', () => {
        searchInput.value = '';
        clearSearchBtn.style.display = 'none';
        filterMarkers('', true);
        searchInput.focus();
    });

    document.getElementById('show-all-toggle').addEventListener('change', (e) => {
        showAllPlayers = e.target.checked;
        filterMarkers(searchInput.value, true);
    });

    function getDirections(buttonElement) {
        const url = `https://maps.google.com/?daddr=${buttonElement.dataset.lat},${buttonElement.dataset.lng}`;
        window.open(url, '_blank');
    }

    function filterMarkers(searchTerm, shouldFitBounds = false) { /* ... (no changes) */ }
    
    // --- UPDATED AND IMPROVED: Notification Modal Logic ---
    const subscribeContainer = document.querySelector('.onesignal-customlink-container');
    
    function handleSubscribeClick() {
        OneSignalDeferred.push(function(OneSignal) {
            OneSignal.User.pushSubscription.optIn().then(() => {
                 alert('Subscribed to notifications successfully!');
                 checkSubscriptionStatus();
            }).catch((error) => {
                 alert('There was an issue subscribing to notifications. Please check browser permissions.');
                 console.error('Subscription error:', error);
                 checkSubscriptionStatus();
            });
        });
    }

    function handleUnsubscribeClick() {
        OneSignalDeferred.push(function(OneSignal) {
             OneSignal.User.pushSubscription.optOut().then(() => {
                alert('Unsubscribed from notifications.');
                checkSubscriptionStatus();
             });
        });
    }

    function checkSubscriptionStatus() {
         OneSignalDeferred.push(async function(OneSignal) {
            const isSubscribed = OneSignal.User.pushSubscription.optedIn;
            subscribeContainer.innerHTML = ''; // Clear previous button
            const button = document.createElement('button');
            if (isSubscribed) {
                button.textContent = 'Unsubscribe from Push Notifications';
                button.onclick = handleUnsubscribeClick;
                button.className = 'unsubscribe-btn'; // Add a class for styling if needed
            } else {
                button.textContent = 'Subscribe to Push Notifications';
                button.onclick = handleSubscribeClick;
                button.className = 'subscribe-btn';
            }
            subscribeContainer.appendChild(button);
        });
    }

    function setupNotificationModal(teammates) {
        const modalOverlay = document.getElementById('notification-modal-overlay');
        const openBtn = document.getElementById('notification-btn');
        const closeBtn = document.getElementById('modal-close-btn');
        const playerSelectionStep = document.getElementById('player-selection-step');
        const settingsStep = document.getElementById('notification-settings-step');
        const teammateList = document.getElementById('teammate-list');
        const changePlayerLink = document.getElementById('change-player-link');
        const saveBtn = document.getElementById('save-settings-btn');
        const settingsTitle = settingsStep.querySelector('h2');
        
        teammateList.innerHTML = '';
        if (teammates && teammates.length > 0) {
            teammates.forEach(player => {
                const li = document.createElement('li');
                li.textContent = player.name;
                li.dataset.id = player.id;
                li.onclick = () => {
                    localStorage.setItem('myPlayerId', player.id);
                    localStorage.setItem('myPlayerName', player.name);
                    showUserSettings(player.name);
                };
                teammateList.appendChild(li);
            });
        } else {
            playerSelectionStep.querySelector('p').textContent = 'No teammates are available to select for notifications at this time.';
        }

        const showUserSettings = (playerName) => {
            playerSelectionStep.style.display = 'none';
            settingsStep.style.display = 'block';
            settingsTitle.innerHTML = `Notification Settings for <span id="my-player-name">${playerName}</span>`;
            loadSettings();
            checkSubscriptionStatus(); // Refresh subscribe button state
        };
        
        openBtn.onclick = () => {
            modalOverlay.style.display = 'flex';
            const myPlayerId = localStorage.getItem('myPlayerId');
            const myPlayerName = localStorage.getItem('myPlayerName');
            if (myPlayerId && myPlayerName) {
                showUserSettings(myPlayerName);
            } else {
                playerSelectionStep.style.display = 'block';
                settingsStep.style.display = 'none';
                // Even on first step, show the correct button state if they are already subscribed
                checkSubscriptionStatus(); 
            }
        };

        changePlayerLink.onclick = (e) => { /* ... (no changes) */ };
        const closeModal = () => modalOverlay.style.display = 'none';
        closeBtn.onclick = closeModal;
        modalOverlay.onclick = (e) => { if (e.target === modalOverlay) closeModal(); };
        
        const enableNotifications = document.getElementById('enable-notifications');
        const fieldset = document.getElementById('notification-fieldset');
        const proximitySlider = document.getElementById('proximity-radius');
        const proximityValue = document.getElementById('proximity-value');
        const ghostSlider = document.getElementById('ghost-radius');
        const ghostValue = document.getElementById('ghost-value');
        const ghostWorldwide = document.getElementById('ghost-worldwide');

        enableNotifications.onchange = () => { fieldset.disabled = !enableNotifications.checked; };
        proximitySlider.oninput = () => { proximityValue.textContent = proximitySlider.value > 0 ? `${proximitySlider.value} mi` : 'Off'; };
        ghostSlider.oninput = () => { ghostValue.textContent = ghostSlider.value > 0 ? `${ghostSlider.value} mi` : 'Off'; };
        ghostWorldwide.onchange = () => {
            ghostSlider.disabled = ghostWorldwide.checked;
            ghostValue.textContent = ghostWorldwide.checked ? 'Worldwide' : (ghostSlider.value > 0 ? `${ghostSlider.value} mi` : 'Off');
        };

        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('notificationSettings')) || {};
            enableNotifications.checked = settings.enabled || false;
            proximitySlider.value = settings.proximityMiles || 0;
            ghostSlider.value = settings.ghostMiles > 0 ? settings.ghostMiles : 0;
            ghostWorldwide.checked = settings.ghostMiles === -1;
            proximitySlider.dispatchEvent(new Event('input'));
            ghostSlider.dispatchEvent(new Event('input'));
            ghostWorldwide.dispatchEvent(new Event('change'));
            enableNotifications.dispatchEvent(new Event('change'));
        }
        
        saveBtn.onclick = async () => { /* ... (no changes) */ };
    } 

    socket.on('disconnect', () => document.querySelector('.subtitle').textContent = 'Disconnected...');
    const setupCollapsiblePanel = (headerId, containerId, iconId) => { /* ... (no changes) */ };
    setupCollapsiblePanel('safezone-header', 'safezone-container', 'safezone-toggle-icon');
    setupCollapsiblePanel('stealth-header', 'stealth-container', 'stealth-toggle-icon');
    setupCollapsiblePanel('not-located-header', 'not-located-container', 'toggle-icon');
</script>

</body>
</html>
